<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>CONFIG VLANS</title>
    <style>
        html, body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        h2 {
            color: #333;
            margin-top: 0;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        h3 {
            color: #495057;
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 18px;
        }
        .info-box {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            color: #0c5460;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 13px;
            letter-spacing: 0.5px;
        }
        tr:hover {
            background-color: #f8f9fa;
        }
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 5px;
        }
        button:hover:not(:disabled) {
            transform: translateY(-2px);
        }
        .btn-edit {
            background: #6c757d;
            color: white;
        }
        .btn-edit:hover:not(:disabled) {
            background: #5a6268;
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.4);
        }
        .btn-delete {
            background: #dc3545;
            color: white;
        }
        .btn-delete:hover:not(:disabled) {
            background: #c82333;
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
        }
        .btn-save {
            background: #28a745;
            color: white;
        }
        .btn-save:hover:not(:disabled) {
            background: #218838;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }
        .btn-cancel {
            background: #ffc107;
            color: #212529;
        }
        .btn-cancel:hover:not(:disabled) {
            background: #e0a800;
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
            transition: border-color 0.3s;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .form-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .submit-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 10px;
        }
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        #output {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #495057;
        }
        small {
            color: #6c757d;
            display: block;
            margin-top: 5px;
            font-size: 12px;
        }
        .protected-badge {
            background: #ffc107;
            color: #212529;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>üè∑Ô∏è Configuraci√≥n de VLANs</h2>

        <div class="info-box">
            <strong>‚ÑπÔ∏è Informaci√≥n:</strong> Configure las VLANs del sistema. Cada VLAN requiere una IP para la interfaz (asignada al router) y una IP de red (para reglas de firewall).
            Las VLANs 1 y 2 est√°n protegidas y no se pueden eliminar.
        </div>

        <h3>VLANs configuradas</h3>

        <table id="vlansTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>IP Interfaz</th>
                    <th>IP Red</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <h3>Nueva VLAN</h3>

        <div class="form-section">
            <form id="vlanForm">
                <div class="form-group">
                    <label>ID VLAN</label>
                    <input type="number" name="id" min="1" max="4094" placeholder="100" required>
                    <small>üí° ID √∫nico entre 1 y 4094</small>
                </div>

                <div class="form-group">
                    <label>Nombre</label>
                    <input type="text" name="name" placeholder="DMZ_Servers" required>
                    <small>üí° Nombre descriptivo para la VLAN</small>
                </div>

                <div class="form-group">
                    <label>IP Interfaz</label>
                    <input type="text" name="ip_interface" placeholder="192.168.1.1/24" required>
                    <small>üí° IP asignada a la interfaz del router (no puede terminar en 0 o 255)</small>
                </div>

                <div class="form-group">
                    <label>IP Red</label>
                    <input type="text" name="ip_network" placeholder="192.168.1.0/24" required>
                    <small>üí° IP de red para reglas de firewall (√∫ltimo octeto debe ser 0)</small>
                </div>

                <button type="submit" class="submit-btn">Guardar VLAN</button>
            </form>
        </div>

        <pre id="output"></pre>
    </div>

<script>
let vlanCache = {};

function isValidCIDR(ip) {
    const parts = ip.split('/');
    if (parts.length !== 2) return false;
    const ipAddr = parts[0];
    const mask = parseInt(parts[1]);
    if (isNaN(mask) || mask < 1 || mask > 32) return false;
    const ipParts = ipAddr.split('.');
    if (ipParts.length !== 4) return false;
    for (let part of ipParts) {
        const num = parseInt(part);
        if (isNaN(num) || num < 0 || num > 255) return false;
    }
    return true;
}

function isValidNetworkIP(ip) {
    if (!isValidCIDR(ip)) return false;
    const ipParts = ip.split('/')[0].split('.');
    const lastOctet = parseInt(ipParts[3]);
    return lastOctet === 0;
}

function isValidInterfaceIP(ip) {
    if (!isValidCIDR(ip)) return false;
    const ipParts = ip.split('/')[0].split('.');
    const lastOctet = parseInt(ipParts[3]);
    return lastOctet !== 0 && lastOctet !== 255;
}

function isIpInNetwork(ipInterface, ipNetwork) {
    try {
        const ipParts = ipInterface.split('/')[0].split('.').map(p => parseInt(p));
        const netParts = ipNetwork.split('/')[0].split('.').map(p => parseInt(p));
        const mask = parseInt(ipNetwork.split('/')[1]);
        
        // Convertir IP e IP de red a n√∫meros de 32 bits
        const ipNum = (ipParts[0] << 24) | (ipParts[1] << 16) | (ipParts[2] << 8) | ipParts[3];
        const netNum = (netParts[0] << 24) | (netParts[1] << 16) | (netParts[2] << 8) | netParts[3];
        
        // Crear m√°scara de red
        const maskNum = (0xFFFFFFFF << (32 - mask)) >>> 0;
        
        // Verificar si la IP est√° en la red
        return (ipNum & maskNum) === (netNum & maskNum);
    } catch (e) {
        return false;
    }
}

function haveSameMask(ipInterface, ipNetwork) {
    try {
        const mask1 = parseInt(ipInterface.split('/')[1]);
        const mask2 = parseInt(ipNetwork.split('/')[1]);
        return mask1 === mask2;
    } catch (e) {
        return false;
    }
}

async function loadVlans() {
    try {
        const response = await fetch("/admin/vlans", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({
                action: "config",
                params: { action: "show" }
            })
        });

        const data = await response.json();
        
        if (!response.ok) {
            document.getElementById("output").textContent = data.detail || "Error cargando VLANs";
            return;
        }

        // Parsear VLANs del mensaje
        const vlans = [];
        const lines = data.message.split('\n');
        for (let line of lines) {
            const match = line.match(/ID:\s*(\d+),\s*Name:\s*([^,]+),\s*IP Interfaz:\s*([^,]+),\s*IP Red:\s*(.+)/);
            if (match) {
                vlans.push({
                    id: parseInt(match[1]),
                    name: match[2].trim(),
                    ip_interface: match[3].trim(),
                    ip_network: match[4].trim()
                });
            }
        }

        const tbody = document.querySelector("#vlansTable tbody");
        tbody.innerHTML = "";
        vlanCache = {};

        // Ordenar por ID
        vlans.sort((a, b) => a.id - b.id);

        vlans.forEach(vlan => {
            vlanCache[vlan.id] = vlan;

            const tr = document.createElement("tr");
            tr.dataset.id = vlan.id;

            const isProtected = (vlan.id === 1 || vlan.id === 2);

            tr.innerHTML = `
                <td>${vlan.id}</td>
                <td>${vlan.name || ""}</td>
                <td>${vlan.ip_interface || ""}</td>
                <td>${vlan.ip_network || ""}</td>
                <td>
                    <button class="btn-edit" onclick="editRow(${vlan.id})">Modificar</button>
                    <button class="btn-delete" onclick="deleteVlan(${vlan.id})" ${isProtected ? 'disabled' : ''}>Eliminar</button>
                </td>
            `;

            tbody.appendChild(tr);
        });

        document.getElementById("output").textContent = "";

    } catch (err) {
        document.getElementById("output").textContent = "Error: " + err.message;
    }
}

function editRow(id) {
    const tr = document.querySelector(`tr[data-id="${id}"]`);
    const vlan = vlanCache[id];

    tr.innerHTML = `
        <td>${vlan.id}</td>
        <td><input type="text" value="${vlan.name || ""}"></td>
        <td><input type="text" value="${vlan.ip_interface || ""}"></td>
        <td><input type="text" value="${vlan.ip_network || ""}"></td>
        <td>
            <button class="btn-save" onclick="saveRow(${id})">Guardar</button>
            <button class="btn-cancel" onclick="cancelEdit()">Cancelar</button>
        </td>
    `;
}

async function saveRow(id) {
    const tr = document.querySelector(`tr[data-id="${id}"]`);
    const inputs = tr.querySelectorAll("input");
    const [name, ip_interface, ip_network] = Array.from(inputs).map(i => i.value.trim());

    if (!isValidCIDR(ip_interface)) {
        alert("IP de interfaz inv√°lida. Formato esperado: 192.168.1.1/24");
        return;
    }

    if (!isValidInterfaceIP(ip_interface)) {
        alert("IP de interfaz no puede terminar en 0 o 255");
        return;
    }

    if (!isValidNetworkIP(ip_network)) {
        alert("IP de red inv√°lida. Debe tener √∫ltimo octeto 0 (ej: 192.168.1.0/24)");
        return;
    }

    if (!haveSameMask(ip_interface, ip_network)) {
        alert("La m√°scara de la IP de interfaz debe coincidir con la m√°scara de la red");
        return;
    }

    if (!isIpInNetwork(ip_interface, ip_network)) {
        alert(`La IP de interfaz ${ip_interface.split('/')[0]} no est√° dentro de la red ${ip_network}`);
        return;
    }

    try {
        const response = await fetch("/admin/vlans", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({
                action: "config",
                params: {
                    action: "add",
                    id: id,
                    name: name,
                    ip_interface: ip_interface,
                    ip_network: ip_network
                }
            })
        });

        const data = await response.json();
        document.getElementById("output").textContent = data.message || data.detail;
        loadVlans();

    } catch (err) {
        document.getElementById("output").textContent = "Error: " + err.message;
    }
}

function cancelEdit() {
    loadVlans();
}

async function deleteVlan(id) {
    if (!confirm(`¬øEliminar VLAN ${id}?`)) return;

    try {
        const response = await fetch("/admin/vlans", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({
                action: "config",
                params: {
                    action: "remove",
                    id: id
                }
            })
        });

        const data = await response.json();
        document.getElementById("output").textContent = data.message || data.detail;
        loadVlans();

    } catch (err) {
        document.getElementById("output").textContent = "Error: " + err.message;
    }
}

document.getElementById("vlanForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const form = e.target;
    const ip_interface = form.ip_interface.value.trim();
    const ip_network = form.ip_network.value.trim();

    if (!isValidCIDR(ip_interface)) {
        alert("IP de interfaz inv√°lida. Formato esperado: 192.168.1.1/24");
        return;
    }

    if (!isValidInterfaceIP(ip_interface)) {
        alert("IP de interfaz no puede terminar en 0 o 255");
        return;
    }

    if (!isValidNetworkIP(ip_network)) {
        alert("IP de red inv√°lida. Debe tener √∫ltimo octeto 0 (ej: 192.168.1.0/24)");
        return;
    }

    if (!haveSameMask(ip_interface, ip_network)) {
        alert("La m√°scara de la IP de interfaz debe coincidir con la m√°scara de la red");
        return;
    }

    if (!isIpInNetwork(ip_interface, ip_network)) {
        alert(`La IP de interfaz ${ip_interface.split('/')[0]} no est√° dentro de la red ${ip_network}`);
        return;
    }

    try {
        const response = await fetch("/admin/vlans", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({
                action: "config",
                params: {
                    action: "add",
                    id: parseInt(form.id.value),
                    name: form.name.value,
                    ip_interface: ip_interface,
                    ip_network: ip_network
                }
            })
        });

        const data = await response.json();
        document.getElementById("output").textContent = data.message || data.detail;

        form.reset();
        loadVlans();

    } catch (err) {
        document.getElementById("output").textContent = "Error: " + err.message;
    }
});

loadVlans();
</script>

</body>
</html>