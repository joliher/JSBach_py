<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>FIREWALL - Men√∫</title>
    <style>
        html, body {
            margin: 0;
            font-family: Arial, sans-serif;
            padding: 10px;
            background-color: #f5f5f5;
        }
        h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            display: block;
            width: 100%;
            margin: 5px 0;
            padding: 10px 12px;
            cursor: pointer;
            border: 1px solid #ccc;
            background-color: #fff;
            font-size: 14px;
            transition: all 0.2s;
        }
        button:hover {
            background-color: #e8f4ff;
        }
        button.selected {
            background-color: #3399ff;
            color: white;
            border-color: #007acc;
            font-weight: bold;
        }
        hr {
            border: none;
            border-top: 1px solid #ddd;
            margin: 15px 0;
        }
        .status-box {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            padding: 8px 12px;
            margin: 10px 0;
            text-align: center;
            font-size: 13px;
            transition: all 0.3s;
        }
        .status-box.activo {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        .status-box.inactivo {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        .status-box.desconocido {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #e9ecef;
        }
        button:disabled:hover {
            background-color: #e9ecef;
        }
        .dependency-warning {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 6px;
            padding: 8px 10px;
            margin: 10px 0;
            font-size: 12px;
            color: #856404;
            display: none;
        }
    </style>
</head>
<body>

<h3>üî• FIREWALL</h3>

<div class="status-box" id="module-status">Estado: Cargando...</div>

<div class="dependency-warning" id="wan-warning">
    ‚ö†Ô∏è La WAN debe estar configurada antes de iniciar el firewall
</div>

<!-- Acciones principales -->
<button id="btnStart"   onclick="runAction('start', this)">üöÄ FIREWALL START</button>
<button id="btnStop"    onclick="runAction('stop', this)">üõë FIREWALL STOP</button>
<button id="btnRestart" onclick="runAction('restart', this)">üîÑ FIREWALL RESTART</button>
<button id="btnStatus"  onclick="runAction('status', this)">üìä FIREWALL STATUS</button>

<hr>

<h4 style="margin: 10px 0; color: #555;">Vista y Configuraci√≥n</h4>

<!-- Configuraci√≥n y visualizaci√≥n -->
<button id="btnViewVlans" onclick="openConfig('vlans', this)">üëÅÔ∏è VER VLANS</button>
<button id="btnConfigWhitelist" onclick="openConfig('whitelist', this)">üìã CONFIG WHITELIST</button>

<hr>

<!-- Visualizaci√≥n -->
<button id="btnInfo" onclick="openInfo(event, this)">‚ÑπÔ∏è VER INFO</button>

<script>
async function runAction(action, btn) {
    const iframe = parent.frames['body'];

    // Resaltar bot√≥n seleccionado
    document.querySelectorAll("button").forEach(b => b.classList.remove("selected"));
    btn.classList.add("selected");
    sessionStorage.setItem("firewallSelected", btn.id);

    // Para start/stop/restart/status, redirigir a status.html para feedback
    if (action === 'start' || action === 'stop' || action === 'restart' || action === 'status') {
        iframe.location.href = "/web/firewall/status.html";
        // Ejecutar acci√≥n en segundo plano
        console.log('Iniciando fetch a /admin/firewall con action:', action);
        
        fetch('/admin/firewall', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: action }),
            credentials: 'include'
        })
        .then(response => {
            console.log('Respuesta recibida:', response.status, response.statusText);
            return response.json();
        })
        .then(data => {
            console.log('Datos recibidos:', data);
        })
        .catch(error => {
            console.error("Error al ejecutar la acci√≥n:", error);
        });
        return;
    }

    // Otras acciones
    iframe.location.href = "/web/firewall/info.html";
}

function openConfig(section, btn) {
    const iframe = parent.frames['body'];

    // Resaltar bot√≥n seleccionado
    document.querySelectorAll("button").forEach(b => b.classList.remove("selected"));
    btn.classList.add("selected");
    sessionStorage.setItem("firewallSelected", btn.id);

    // Redirigir a la p√°gina correspondiente
    if (section === "vlans") {
        iframe.location.href = "/web/firewall/view_vlans.html";
    } else if (section === "whitelist") {
        iframe.location.href = "/web/firewall/config_whitelist.html";
    }
}

function openInfo(event, btn) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    const iframe = parent.frames['body'];
    if (!iframe) return;

    document.querySelectorAll("button").forEach(b => b.classList.remove("selected"));
    btn.classList.add("selected");
    sessionStorage.setItem("firewallSelected", btn.id);

    iframe.location.href = "/web/firewall/info.html";
}

function openLogs(btn) {
    const iframe = parent.frames['body'];

    // Resaltar bot√≥n seleccionado
    document.querySelectorAll("button").forEach(b => b.classList.remove("selected"));
    btn.classList.add("selected");
    sessionStorage.setItem("firewallSelected", btn.id);

    // Cargar logs
    iframe.location.href = "/web/firewall/logs.html";
}

// Mantener bot√≥n seleccionado al recargar
window.addEventListener("DOMContentLoaded", () => {
    const saved = sessionStorage.getItem("firewallSelected");
    if (saved) {
        const btn = document.getElementById(saved);
        if (btn) btn.classList.add("selected");
    }
    fetchModuleStatus();
});

// Funci√≥n para obtener el estado del m√≥dulo con polling adaptativo
let lastStatus = '';
let pollInterval = 2000;
let unchangedCount = 0;
let statusTimerId = null;
let wanConfigured = false;

function fetchModuleStatus() {
    fetch('/admin/status', { credentials: 'include' })
        .then(response => response.json())
        .then(data => {
            const status = data['firewall'] || 'DESCONOCIDO';
            const wanStatus = data['wan'] || 'DESCONOCIDO';
            
            // Verificar si WAN est√° configurada
            wanConfigured = (wanStatus !== 'DESCONOCIDO' && wanStatus !== 'ERROR');
            
            // Deshabilitar bot√≥n START si WAN no est√° configurada
            const btnStart = document.getElementById('btnStart');
            const wanWarning = document.getElementById('wan-warning');
            
            if (!wanConfigured) {
                btnStart.disabled = true;
                btnStart.title = 'La WAN debe estar configurada primero';
                wanWarning.style.display = 'block';
            } else {
                btnStart.disabled = false;
                btnStart.title = '';
                wanWarning.style.display = 'none';
            }
            
            if (status === lastStatus) {
                unchangedCount++;
                if (unchangedCount > 3) pollInterval = 5000;
                if (unchangedCount > 10) pollInterval = 10000;
                if (unchangedCount > 20) pollInterval = 30000;
            } else {
                lastStatus = status;
                unchangedCount = 0;
                pollInterval = 2000;
                
                const statusBox = document.getElementById('module-status');
                statusBox.textContent = `Estado: ${status}`;
                statusBox.classList.remove('activo', 'inactivo', 'desconocido');
                
                if (status === 'ACTIVO') {
                    statusBox.classList.add('activo');
                } else if (status === 'INACTIVO') {
                    statusBox.classList.add('inactivo');
                } else {
                    statusBox.classList.add('desconocido');
                }
            }
            
            clearTimeout(statusTimerId);
            statusTimerId = setTimeout(fetchModuleStatus, pollInterval);
        })
        .catch(error => {
            console.error('Error al obtener estado:', error);
            clearTimeout(statusTimerId);
            statusTimerId = setTimeout(fetchModuleStatus, 5000);
        });
}
</script>

</body>
</html>
