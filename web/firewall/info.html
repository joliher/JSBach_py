<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>FIREWALL - Manual de Uso</title>
    <style>
        html, body { 
            margin: 0; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .info-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        h2 {
            color: #333;
            margin-top: 0;
            font-size: 28px;
        }
        h3 {
            color: #667eea;
            margin-top: 25px;
            font-size: 20px;
        }
        p, li {
            color: #666;
            line-height: 1.8;
            font-size: 15px;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            border-radius: 4px;
        }
        .warning {
            background: #fff3cd;
            border-left-color: #ffc107;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        .success {
            background: #d4edda;
            border-left-color: #28a745;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        code {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            color: #d63384;
        }
    </style>
</head>
<body>
    <div class="info-container">
        <h2>üî• FIREWALL - Manual de Uso</h2>
        
        <div class="section">
            <h3>üìã Descripci√≥n General</h3>
            <p>El m√≥dulo Firewall permite gestionar reglas de iptables con una <strong>arquitectura jer√°rquica por VLANs</strong>. Utiliza cadenas de protecci√≥n globales y cadenas espec√≠ficas por VLAN para un control granular del tr√°fico.</p>
            <p><strong>Arquitectura V2.0:</strong> INPUT_PROTECTION (pos 1) + INPUT_VLAN_X (pos 2+) | FORWARD_PROTECTION (pos 1) + FORWARD_VLAN_X (pos 2+)</p>
        </div>

        <div class="section">
            <h3>‚öôÔ∏è Requisitos Previos</h3>
            <ul>
                <li><strong>‚ö†Ô∏è WAN debe estar configurada</strong> - El firewall requiere que la interfaz WAN est√© configurada antes de iniciarse</li>
                <li>Tener VLANs configuradas en el sistema</li>
                <li>Permisos sudo configurados para iptables</li>
                <li>Verificar con: <code>sudo iptables -L -n</code></li>
            </ul>
        </div>

        <div class="section">
            <h3>üéØ Funciones Principales</h3>
            
            <p><strong>START:</strong> Inicia el firewall con arquitectura jer√°rquica</p>
            <ul>
                <li>Crea cadenas de protecci√≥n: <code>INPUT_PROTECTION</code> (pos 1), <code>FORWARD_PROTECTION</code> (pos 1)</li>
                <li>Crea cadena <code>INPUT_VLAN_X</code> para restricciones al router (vinculada en pos 2+)</li>
                <li>Crea cadena <code>FORWARD_VLAN_X</code> para whitelist (vinculada en pos 2+)</li>
                <li><strong>Pol√≠ticas por defecto:</strong> VLAN 1 aislada autom√°ticamente, resto restringidas (DHCP+DNS+ICMP permitidos)</li>
                <li>Por defecto, FORWARD_VLAN_X en ACCEPT (sin whitelist)</li>
                <li>Guarda configuraci√≥n en <code>config/firewall/firewall.json</code></li>
            </ul>

            <p><strong>STOP:</strong> Detiene el firewall eliminando todas las cadenas</p>
            <ul>
                <li><strong>Desvincula las cadenas de FORWARD</strong> eliminando las reglas de salto</li>
                <li>Limpia reglas de cada cadena VLAN</li>
                <li>Elimina las cadenas personalizadas</li>
                <li>Actualiza estado a detenido</li>
            </ul>

            <p><strong>RESTART:</strong> Reinicia el firewall (ejecuta STOP seguido de START)</p>

            <p><strong>STATUS:</strong> Muestra el estado actual del firewall</p>
            <ul>
                <li>Lista cada VLAN y su estado (ACTIVA/INACTIVA)</li>
                <li><strong>Verifica vinculaci√≥n a FORWARD:</strong> indica si la cadena est√° activa</li>
                <li>Muestra la IP de origen de cada VLAN</li>
                <li>Muestra si la whitelist est√° habilitada</li>
                <li>Muestra las primeras reglas activas de iptables</li>
            </ul>
        </div>

        <div class="section">
            <h3>üîê Funciones de Whitelist</h3>
            
            <p><strong>ENABLE_WHITELIST:</strong> Habilita whitelist en una VLAN (bloquea todo excepto destinos permitidos)</p>
            <ul>
                <li>Par√°metros: <code>vlan_id</code>, <code>whitelist</code> (lista de IPs/puertos)</li>
                <li>Formato de reglas: <code>"192.168.1.1"</code> o <code>"192.168.1.1:80"</code></li>
                <li>Agrega regla DROP al final para bloquear todo lo dem√°s</li>
            </ul>

            <p><strong>DISABLE_WHITELIST:</strong> Deshabilita whitelist (vuelve a ACCEPT todo)</p>
            <ul>
                <li>Par√°metros: <code>vlan_id</code></li>
                <li>Limpia todas las reglas de la cadena</li>
                <li>Restaura comportamiento permisivo</li>
            </ul>

            <p><strong>ADD_RULE:</strong> Agrega una regla a la whitelist existente</p>
            <ul>
                <li>Par√°metros: <code>vlan_id</code>, <code>rule</code></li>
                <li>Ejemplo: <code>{"vlan_id": 1, "rule": "8.8.8.8"}</code></li>
                <li>Reaplica autom√°ticamente la whitelist si est√° habilitada</li>
            </ul>

            <p><strong>REMOVE_RULE:</strong> Elimina una regla de la whitelist</p>
            <ul>
                <li>Par√°metros: <code>vlan_id</code>, <code>rule</code></li>
                <li>Reaplica la whitelist sin esa regla</li>
            </ul>
        </div>

        <div class="section">
            <h3>üîí Funciones de Aislamiento y Restricci√≥n</h3>
            
            <p><strong>AISLAR:</strong> Bloquea nuevas conexiones entre VLANs (FORWARD_PROTECTION)</p>
            <ul>
                <li>Par√°metros: <code>vlan_id</code></li>
                <li>Inserta reglas DROP con <code>-m conntrack --ctstate NEW</code> en <code>FORWARD_PROTECTION</code></li>
                <li>VLAN 1: Bloquea tr√°fico entrante <code>-d VLAN_IP</code> (protege VLAN 1)</li>
                <li>Otras: Bloquea tr√°fico saliente <code>-s VLAN_IP</code> (a√≠sla VLAN)</li>
                <li><strong>Conexiones establecidas contin√∫an funcionando</strong> (solo bloquea nuevas)</li>
                <li>Independiente de whitelist y restricciones INPUT</li>
            </ul>

            <p><strong>DESAISLAR:</strong> Elimina el bloqueo de nuevas conexiones</p>
            <ul>
                <li>Par√°metros: <code>vlan_id</code></li>
                <li>Elimina reglas conntrack de <code>FORWARD_PROTECTION</code></li>
            </ul>

            <p><strong>RESTRICT:</strong> Bloquea acceso al router (INPUT_VLAN_X)</p>
            <ul>
                <li>Par√°metros: <code>vlan_id</code></li>
                <li><strong>VLAN 1 y 2:</strong> DROP total en INPUT_VLAN_X</li>
                <li><strong>Otras VLANs:</strong> Permite DHCP (67-68), DNS (53) e ICMP; DROP resto</li>
                <li>Se aplica autom√°ticamente al hacer START (pol√≠tica predeterminada)</li>
                <li>Diferente del aislamiento: afecta INPUT (router), no FORWARD (VLANs)</li>
            </ul>

            <p><strong>UNRESTRICT:</strong> Elimina restricciones INPUT de una VLAN</p>
            <ul>
                <li>Par√°metros: <code>vlan_id</code></li>
                <li>Limpia INPUT_VLAN_X dej√°ndola sin reglas (permitiendo todo)</li>
            </ul>
        </div>

        <div class="section">
            <h3>üîß Configuraci√≥n de VLANs</h3>
            <p>El firewall lee la configuraci√≥n desde <code>config/vlans/vlans.json</code>:</p>
            <ul>
                <li>VLAN ID: Identificador num√©rico</li>
                <li>Nombre: Etiqueta descriptiva</li>
                <li>IP: Direcci√≥n IP de la interfaz VLAN</li>
            </ul>
        </div>

        <div class="warning">
            <h3>‚ö†Ô∏è Advertencias</h3>
            <ul>
                <li><strong>Las cadenas se vinculan autom√°ticamente a FORWARD:</strong> el tr√°fico desde las IPs de VLAN pasa por las cadenas personalizadas</li>
                <li>Por defecto, las reglas est√°n en ACCEPT (sin bloqueo)</li>
                <li>El filtrado es por IP de origen (-s): tr√°fico saliente desde cada VLAN</li>
                <li>Use la interfaz web para configurar whitelist y reglas espec√≠ficas</li>
                <li>Aseg√∫rese de tener acceso alternativo al servidor antes de aplicar reglas restrictivas</li>
            </ul>
        </div>

        <div class="success">
            <h3>‚úÖ Ejemplo de Uso</h3>
            <ol>
                <li>Configure VLANs en el m√≥dulo correspondiente</li>
                <li>Haga clic en <strong>START</strong> para inicializar el firewall</li>
                <li>Use <strong>STATUS</strong> para verificar las cadenas creadas</li>
                <li><strong>Para habilitar whitelist:</strong>
                    <ul>
                        <li>Use la interfaz web o API con: <code>enable_whitelist</code></li>
                        <li>Par√°metros: <code>{"vlan_id": 1, "whitelist": ["8.8.8.8", "1.1.1.1:53"]}</code></li>
                    </ul>
                </li>
                <li><strong>Para agregar m√°s reglas:</strong> Use <code>add_rule</code> con <code>{"vlan_id": 1, "rule": "192.168.1.1"}</code></li>
                <li>Use <strong>RESTART</strong> para reaplicar configuraci√≥n si es necesario</li>
            </ol>
        </div>

        <div class="section">
            <h3>üìÅ Archivos de Configuraci√≥n</h3>
            <ul>
                <li><code>config/vlans/vlans.json</code> - Configuraci√≥n de VLANs</li>
                <li><code>config/firewall/firewall.json</code> - Estado y reglas del firewall</li>
                <li><code>logs/firewall/</code> - Directorio de logs</li>
            </ul>
        </div>

        <div class="section">
            <h3>üêõ Diagn√≥stico</h3>
            <p>Si encuentra problemas:</p>
            <ul>
                <li>Verifique logs del servidor en la terminal</li>
                <li>Ejecute <code>sudo iptables -L -n -v</code> para ver reglas actuales</li>
                <li>Verifique que sudo funcione sin contrase√±a: <code>sudo -n iptables -L</code></li>
                <li>Revise <code>config/firewall/firewall.json</code> para ver configuraci√≥n guardada</li>
            </ul>
        </div>

        <div class="section">
            <h3>üîÑ Versi√≥n</h3>
            <p>Firewall Module v2.0 - Arquitectura Jer√°rquica con Cadenas de Protecci√≥n</p>
            <p><strong>Nuevo en v2.0 (Refactorizaci√≥n Completa):</strong></p>
            <ul>
                <li>üèóÔ∏è <strong>Arquitectura jer√°rquica:</strong> Cadenas de protecci√≥n (pos 1) + cadenas por VLAN (pos 2+)</li>
                <li>üîê <strong>INPUT_PROTECTION:</strong> Protecci√≥n del router desde WAN (solo ICMP permitido)</li>
                <li>üîê <strong>FORWARD_PROTECTION:</strong> Aislamiento de VLANs con conntrack (solo nuevas conexiones)</li>
                <li>üéØ <strong>INPUT_VLAN_X:</strong> Restricciones individuales al router por VLAN</li>
                <li>üéØ <strong>FORWARD_VLAN_X:</strong> Whitelist individual por VLAN</li>
                <li>üîß <strong>Pol√≠ticas predeterminadas:</strong> VLAN 1 aislada, resto restringidas (DHCP+DNS+ICMP)</li>
                <li>‚úÖ <strong>DMZ integrado:</strong> Reglas ACCEPT en FORWARD_VLAN_X preservadas al modificar whitelist</li>
                <li>üõ°Ô∏è <strong>Protecci√≥n de posici√≥n:</strong> Auto-correcci√≥n si cadenas de protecci√≥n cambian de posici√≥n</li>
            </ul>
            <p><strong>Versiones anteriores:</strong></p>
            <ul>
                <li>v1.x: Arquitectura legacy con SECURITY_DROPS_FIREWALL</li>
            </ul>
            <p>√öltima actualizaci√≥n: Enero 2026</p>
        </div>
    </div>
</body>
</html>
