<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Ver VLANs - Firewall</title>
    <style>
        html, body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        h2 {
            color: #333;
            margin-top: 0;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        .info-box {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            color: #0c5460;
        }
        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            color: #856404;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 18px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        th {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 0.5px;
        }
        td {
            font-size: 14px;
            color: #333;
        }
        tbody tr:hover {
            background: #f8f9fa;
        }
        tbody tr:last-child td {
            border-bottom: none;
        }
        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }
        .whitelist-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
            background: #d4edda;
            color: #155724;
        }
        .whitelist-badge.disabled {
            background: #e2e3e5;
            color: #6c757d;
        }
        .rule-count {
            font-family: 'Courier New', monospace;
            background: #e9ecef;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 12px;
            color: #495057;
        }
        code {
            background: #e9ecef;
            padding: 3px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #d63384;
            font-size: 13px;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }
        .status-matrix {
            display: grid;
            grid-template-columns: auto auto auto auto;
            gap: 8px;
            align-items: center;
            font-size: 12px;
        }
        .status-matrix-label {
            font-weight: 600;
            color: #555;
            text-align: right;
            min-width: 90px;
        }
        .status-matrix-value {
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 500;
            text-align: center;
            min-width: 80px;
        }
        .status-matrix-value.active {
            background: #d4edda;
            color: #155724;
        }
        .status-matrix-value.inactive {
            background: #f8d7da;
            color: #721c24;
        }
        .status-matrix-value.disabled {
            background: #e2e3e5;
            color: #6c757d;
        }
        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .action-buttons button {
            padding: 6px 12px;
            font-size: 11px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            background: white;
            transition: all 0.2s;
        }
        .action-buttons button:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        .action-buttons button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>üëÅÔ∏è Vista de VLANs - Firewall</h2>

        <div class="info-box">
            <strong>‚ÑπÔ∏è Informaci√≥n:</strong> Esta p√°gina muestra las VLANs configuradas en el sistema y su estado en el firewall. 
            Para iniciar/detener el firewall para todas las VLANs, use los botones START/STOP en el men√∫ principal.
        </div>

        <div id="content" class="loading">
            Cargando configuraci√≥n de VLANs...
        </div>
    </div>

    <script>
        let firewallConfig = {};
        let vlansConfig = {};

        async function loadConfig() {
            try {
                console.log('[DEBUG] Iniciando loadConfig...');
                
                // Cargar configuraci√≥n del firewall
                console.log('[DEBUG] Cargando firewall config...');
                const fwResponse = await fetch('/admin/config/firewall/firewall.json', {
                    credentials: 'include'
                });
                
                console.log('[DEBUG] Firewall response status:', fwResponse.status);
                
                if (!fwResponse.ok) {
                    throw new Error('No se pudo cargar la configuraci√≥n del firewall. Status: ' + fwResponse.status);
                }

                firewallConfig = await fwResponse.json();
                console.log('[DEBUG] Firewall config cargada:', firewallConfig);

                // Cargar configuraci√≥n de VLANs
                console.log('[DEBUG] Cargando VLANs config...');
                const vlansResponse = await fetch('/admin/config/vlans/vlans.json', {
                    credentials: 'include'
                });

                console.log('[DEBUG] VLANs response status:', vlansResponse.status);
                
                if (!vlansResponse.ok) {
                    throw new Error('No se pudo cargar la configuraci√≥n de VLANs. Status: ' + vlansResponse.status);
                }

                vlansConfig = await vlansResponse.json();
                console.log('[DEBUG] VLANs config cargada:', vlansConfig);
                console.log('[DEBUG] Llamando a renderTable...');
                renderTable();

            } catch (error) {
                console.error('Error cargando configuraci√≥n:', error);
                document.getElementById('content').innerHTML = `
                    <div class="warning-box">
                        ‚ö†Ô∏è Error al cargar configuraci√≥n. Aseg√∫rese de que:
                        <ul style="margin: 10px 0 0 20px;">
                            <li>El firewall est√© iniciado (START)</li>
                            <li>Existan VLANs configuradas en el sistema</li>
                            <li>Los archivos de configuraci√≥n sean accesibles</li>
                        </ul>
                    </div>
                `;
            }
        }

        function renderTable() {
            console.log('[DEBUG] renderTable iniciada');
            const fwVlans = firewallConfig.vlans || {};
            const systemVlans = vlansConfig.vlans || [];
            
            console.log('[DEBUG] fwVlans:', fwVlans);
            console.log('[DEBUG] systemVlans:', systemVlans);
            console.log('[DEBUG] systemVlans.length:', systemVlans.length);

            if (systemVlans.length === 0) {
                console.log('[DEBUG] No hay VLANs, mostrando mensaje');
                document.getElementById('content').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <h3>No hay VLANs configuradas</h3>
                        <p>Configure VLANs en el m√≥dulo correspondiente para verlas aqu√≠.</p>
                    </div>
                `;
                return;
            }
            
            console.log('[DEBUG] Construyendo tabla HTML...');

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>VLAN ID</th>
                            <th>Nombre</th>
                            <th>IP/M√°scara</th>
                            <th>Estado Firewall</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            // Ordenar VLANs por ID
            systemVlans.sort((a, b) => a.id - b.id);

            systemVlans.forEach(vlan => {
                const vlanId = vlan.id;
                const vlanName = vlan.name || 'Sin nombre';
                const vlanIp = vlan.ip_network || 'N/A';
                
                // Informaci√≥n del firewall para esta VLAN
                const fwVlan = fwVlans[String(vlanId)] || {};
                const isActive = fwVlan.enabled || false;
                const isolated = fwVlan.isolated || false;
                const whitelistEnabled = fwVlan.whitelist_enabled || false;
                const whitelistRules = fwVlan.whitelist || [];
                const restricted = fwVlan.restricted || false;
                const ruleCount = whitelistRules.length;
                
                // Generar matriz de estado (m√°s compacta y visual)
                const stateMatrix = `
                    <div class="status-matrix">
                        <div class="status-matrix-label">Cadena FW:</div>
                        <div class="status-matrix-value ${isActive ? 'active' : 'inactive'}">
                            ${isActive ? '‚úì Activa' : '‚úó Inactiva'}
                        </div>
                        <div class="status-matrix-label">Whitelist:</div>
                        <div class="status-matrix-value ${vlanId == 1 || vlanId == 2 ? 'disabled' : (whitelistEnabled ? 'active' : 'inactive')}">
                            ${vlanId == 1 || vlanId == 2 ? 'N/A' : (whitelistEnabled ? `‚úì (${ruleCount})` : '‚úó')}
                        </div>
                        <div class="status-matrix-label">Aislada:</div>
                        <div class="status-matrix-value ${isolated ? 'active' : 'inactive'}">
                            ${isolated ? '‚úì S√≠' : '‚úó No'}
                        </div>
                        <div class="status-matrix-label">Restricciones:</div>
                        <div class="status-matrix-value ${restricted ? 'active' : 'inactive'}">
                            ${restricted ? '‚úì Activas' : '‚úó No'}
                        </div>
                    </div>
                `;

                html += `
                    <tr>
                        <td style="font-weight: bold; text-align: center; width: 60px;">${vlanId}</td>
                        <td style="width: 150px;">${vlanName}</td>
                        <td><code>${vlanIp}</code></td>
                        <td style="width: 400px;">
                            ${stateMatrix}
                        </td>
                    </tr>
                `;
            });
            
            console.log('[DEBUG] Tabla construida, actualizando DOM...');
            
            html += `
                    </tbody>
                </table>

                <div class="info-box" style="margin-top: 30px;">
                    <strong>‚ÑπÔ∏è Informaci√≥n de Estados:</strong>
                    <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
                        <li><strong>Cadena FW:</strong> Estado de la cadena de firewall para la VLAN.</li>
                        <li><strong>Whitelist:</strong> Modo whitelist habilitado (solo VLANs 3+). N√∫mero de reglas entre par√©ntesis.</li>
                        <li><strong>Aislada:</strong> Bloquea tr√°fico entre VLANs (FORWARD).</li>
                        <li><strong>Restricciones:</strong> Bloquea acceso al router (INPUT). Para VLANs 1-2: DROP total. Para otras: permite DHCP e ICMP.</li>
                    </ul>
                </div>

                <div class="info-box" style="margin-top: 20px;">
                    <strong>üí° Gesti√≥n de Firewall:</strong>
                    <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
                        <li><strong>START/STOP:</strong> Usa el men√∫ principal para activar/desactivar el firewall</li>
                        <li><strong>CONFIG WHITELIST:</strong> Configurar reglas de whitelist, aislar/desaislar y restringir/desrestringir</li>
                        <li><strong>STATUS:</strong> Ver estado detallado y reglas de iptables activas</li>
                    </ul>
                </div>
            `;

            document.getElementById('content').innerHTML = html;
            console.log('[DEBUG] Tabla renderizada exitosamente');
        }

        // Cargar configuraci√≥n al iniciar
        window.addEventListener('DOMContentLoaded', loadConfig);

        // Recargar cada 10 segundos para mantener actualizado
        setInterval(loadConfig, 10000);
    </script>
</body>
</html>
