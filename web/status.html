<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estado de los Servicios WAN</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
        }

        .container {
            width: 80%;
            margin: 30px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h3 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table, th, td {
            border: 1px solid #ddd;
        }

        th, td {
            padding: 12px;
            text-align: center;
        }

        th {
            background-color: #f1f1f1;
            font-size: 16px;
        }

        td {
            font-size: 14px;
        }

        .status {
            font-weight: bold;
        }

        .activo {
            color: #28a745;
        }

        .inactivo {
            color: #dc3545;
        }

        .desconocido {
            color: #ffc107;
        }

        .stop-all-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            margin: 20px auto;
            display: block;
            transition: background-color 0.3s;
        }

        .stop-all-btn:hover {
            background-color: #c82333;
        }

        .stop-all-btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }

        #stop-message {
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
            display: none;
        }

        .success-msg {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error-msg {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h3>Estado de los Servicios WAN</h3>
        
        <div id="wan-interface-info" style="background: #e3f2fd; border: 1px solid #90caf9; border-radius: 6px; padding: 15px; margin-bottom: 20px; display: none;">
            <strong>üåê Interfaz WAN configurada:</strong> <span id="wan-interface" style="font-family: monospace; font-weight: bold; color: #1976d2;"></span>
            <span id="wan-mode" style="margin-left: 15px; color: #666;"></span>
        </div>
        
        <table>
            <thead>
                <tr>
                    <th>Servicio</th>
                    <th>Estado</th>
                </tr>
            </thead>
            <tbody id="status-table">
                <!-- Los estados se llenar√°n din√°micamente -->
            </tbody>
        </table>

        <button class="stop-all-btn" onclick="stopAllModules()" id="stop-btn">üõë Detener Todos los M√≥dulos</button>
        <div id="stop-message"></div>
    </div>

    <script>
        // Funci√≥n para obtener el estado de los m√≥dulos
        function fetchStatus() {
            fetch('/admin/status')
                .then(response => response.json())
                .then(data => {
                    const tableBody = document.getElementById("status-table");
                    tableBody.innerHTML = "";  // Limpiar tabla antes de llenarla

                    // Orden de m√≥dulos por dependencias (de arriba a abajo: descendientes -> base)
                    const moduleOrder = ['ebtables', 'dmz', 'firewall', 'nat', 'tagging', 'vlans', 'wan'];
                    
                    moduleOrder.forEach(module => {
                        const status = data[module] || 'DESCONOCIDO';
                        let statusClass = 'desconocido';
                        if (status === 'ACTIVO') {
                            statusClass = 'activo';
                        } else if (status === 'INACTIVO') {
                            statusClass = 'inactivo';
                        }

                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${module.toUpperCase()}</td>
                            <td class="status ${statusClass}">${status}</td>
                        `;
                        tableBody.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error("Error al obtener el estado:", error);
                    document.getElementById("status-table").innerHTML = `
                        <tr>
                            <td colspan="2" style="text-align: center; color: red;">Error al obtener el estado de los m√≥dulos.</td>
                        </tr>
                    `;
                });
        }
        
        // Funci√≥n para detener todos los m√≥dulos
        async function stopAllModules() {
            // Orden de detenci√≥n: inverso de las dependencias
            // Ebtables (depende de WAN, VLANs, Tagging) ‚Üí Firewall (depende de VLANs) ‚Üí DMZ (depende de NAT)
            // ‚Üí NAT (depende de WAN) ‚Üí Tagging (depende de VLANs) ‚Üí VLANs ‚Üí WAN
            const modules = ['ebtables', 'firewall', 'dmz', 'nat', 'tagging', 'vlans', 'wan'];
            const stopBtn = document.getElementById('stop-btn');
            const messageDiv = document.getElementById('stop-message');
            
            stopBtn.disabled = true;
            stopBtn.textContent = '‚è≥ Deteniendo m√≥dulos...';
            messageDiv.style.display = 'none';
            
            let successCount = 0;
            let failedModules = [];
            
            for (const module of modules) {
                try {
                    const response = await fetch(`/admin/${module}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            action: 'stop',
                            params: null
                        })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        successCount++;
                    } else {
                        failedModules.push(module);
                    }
                } catch (error) {
                    console.error(`Error al detener ${module}:`, error);
                    failedModules.push(module);
                }
            }
            
            // Mostrar resultado
            messageDiv.style.display = 'block';
            if (failedModules.length === 0) {
                messageDiv.className = 'success-msg';
                messageDiv.textContent = `‚úÖ Todos los m√≥dulos (${successCount}) han sido detenidos correctamente`;
            } else {
                messageDiv.className = 'error-msg';
                messageDiv.textContent = `‚ö†Ô∏è ${successCount} m√≥dulos detenidos. Fallos en: ${failedModules.join(', ')}`;
            }
            
            // Actualizar tabla de estado
            setTimeout(() => {
                fetchStatus();
            }, 1000);
            
            // Reactivar bot√≥n
            stopBtn.disabled = false;
            stopBtn.textContent = 'üõë Detener Todos los M√≥dulos';
        }
        
        // Funci√≥n para obtener la configuraci√≥n WAN
        function fetchWanConfig() {
            fetch('/admin/config/wan/wan.json')
                .then(response => response.json())
                .then(data => {
                    const interfaceElement = document.getElementById("wan-interface");
                    const modeElement = document.getElementById("wan-mode");
                    const infoBox = document.getElementById("wan-interface-info");
                    
                    if (data.interface) {
                        interfaceElement.textContent = data.interface;
                        modeElement.textContent = data.mode ? `(${data.mode.toUpperCase()})` : '';
                        infoBox.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error("Error al obtener la configuraci√≥n WAN:", error);
                });
        }

        // Llamar las funciones al cargar la p√°gina
        window.onload = function() {
            fetchStatus();
            fetchWanConfig();
        };
    </script>
</body>
</html>