<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Tagging - Men√∫</title>
    <style>
        html, body {
            margin: 0;
            font-family: Arial, sans-serif;
            padding: 10px;
            background-color: #f5f5f5;
        }
        h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            display: block;
            width: 100%;
            margin: 5px 0;
            padding: 10px 12px;
            cursor: pointer;
            border: 1px solid #ccc;
            background-color: #fff;
            font-size: 14px;
            transition: all 0.2s;
        }
        button:hover {
            background-color: #e8f4ff;
        }
        button.selected {
            background-color: #3399ff;
            color: white;
            border-color: #007acc;
            font-weight: bold;
        }
        hr {
            border: none;
            border-top: 1px solid #ddd;
            margin: 15px 0;
        }
        .status-box {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            padding: 8px 12px;
            margin: 10px 0;
            text-align: center;
            font-size: 13px;
            transition: all 0.3s;
        }
        .status-box.activo {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        .status-box.inactivo {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        .status-box.desconocido {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }
        .dependency-warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 4px;
            padding: 8px;
            margin: 10px 0;
            font-size: 12px;
        }
    </style>
</head>
<body>

<h3>üè∑Ô∏è TAGGING</h3>

<div class="status-box" id="module-status">Estado: Cargando...</div>

<div class="dependency-warning">
    <strong>‚ö†Ô∏è Dependencias requeridas:</strong><br>
    <div id="dep-vlans" style="margin: 3px 0;">üîÑ VLANs: Comprobando...</div>
</div>

<button type="button" id="btnStart"   onclick="runTagging(event, 'start', this)">üöÄ TAGGING START</button>
<button type="button" id="btnStop"    onclick="runTagging(event, 'stop', this)">üõë TAGGING STOP</button>
<button type="button" id="btnRestart" onclick="runTagging(event, 'restart', this)">üîÑ TAGGING RESTART</button>
<button type="button" id="btnStatus"  onclick="runTagging(event, 'status', this)">üìä TAGGING STATUS</button>

<hr>

<h4>Configuraci√≥n</h4>

<button type="button" id="btnConfig"  onclick="runTagging(event, 'config', this)">‚öôÔ∏è TAGGING CONFIG</button>

<hr>

<button type="button" id="btnInfo"    onclick="openInfo(event, this)">‚ÑπÔ∏è VER INFO</button>

<script>
function runTagging(event, action, btn) {
    // üîí Evitar que el bot√≥n navegue el iframe izquierdo
    event.preventDefault();
    event.stopPropagation();

    const iframe = parent.frames['body'];
    if (!iframe) {
        console.error("Iframe 'body' no encontrado");
        return;
    }

    // Marcar bot√≥n seleccionado
    const botones = document.querySelectorAll("button");
    botones.forEach(b => b.classList.remove("selected"));
    btn.classList.add("selected");

    sessionStorage.setItem("taggingSelected", btn.id);

    // Acci√≥n CONFIG ‚Üí cargar config.html en iframe derecho
    if (action === "config") {
        iframe.location.href = "/web/tagging/config.html";
        return;
    }

    // Acciones START/STOP/RESTART/STATUS ‚Üí cargar status.html para feedback
    if (action === "start" || action === "stop" || action === "restart" || action === "status") {
        iframe.location.href = "/web/tagging/status.html";
        // Ejecutar acci√≥n backend
        fetch('/admin/tagging', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action }),
            credentials: 'include'
        }).catch(error => {
            console.error("Error al ejecutar la acci√≥n:", error);
        });
        return;
    }

    // Otras acciones ‚Üí mostrar info.html
    iframe.location.href = "/web/tagging/info.html";
}

// Restaurar bot√≥n seleccionado
window.addEventListener("DOMContentLoaded", () => {
    const saved = sessionStorage.getItem("taggingSelected");
    if (saved) {
        const btn = document.getElementById(saved);
        if (btn) btn.classList.add("selected");
    }
    fetchModuleStatus();
});

// Funci√≥n para obtener el estado del m√≥dulo con polling adaptativo
let lastStatus = '';
let pollInterval = 2000;
let unchangedCount = 0;
let statusTimerId = null;

function fetchModuleStatus() {
    fetch('/admin/status', { credentials: 'include' })
        .then(response => response.json())
        .then(data => {
            const status = data['tagging'] || 'DESCONOCIDO';
            
            if (status === lastStatus) {
                unchangedCount++;
                if (unchangedCount > 3) pollInterval = 5000;
                if (unchangedCount > 10) pollInterval = 10000;
                if (unchangedCount > 20) pollInterval = 30000;
            } else {
                lastStatus = status;
                unchangedCount = 0;
                pollInterval = 2000;
                
                const statusBox = document.getElementById('module-status');
                statusBox.textContent = `Estado: ${status}`;
                statusBox.classList.remove('activo', 'inactivo', 'desconocido');
                
                if (status === 'ACTIVO') {
                    statusBox.classList.add('activo');
                } else if (status === 'INACTIVO') {
                    statusBox.classList.add('inactivo');
                } else {
                    statusBox.classList.add('desconocido');
                }
            }
            
            clearTimeout(statusTimerId);
            statusTimerId = setTimeout(fetchModuleStatus, pollInterval);
        })
        .catch(error => {
            console.error('Error al obtener estado:', error);
            clearTimeout(statusTimerId);
            statusTimerId = setTimeout(fetchModuleStatus, 5000);
        });
}

function openInfo(event, btn) {
    event.preventDefault();
    event.stopPropagation();

    const iframe = parent.frames['body'];
    if (!iframe) return;

    document.querySelectorAll("button").forEach(b => b.classList.remove("selected"));
    btn.classList.add("selected");
    sessionStorage.setItem("taggingSelected", btn.id);

    iframe.location.href = "/web/tagging/info.html";
}

async function checkDependencies() {
    // Verificar VLANs
    const btnStart = document.getElementById('btnStart');
    try {
        const vlansResp = await fetch('/admin/vlans/info', { credentials: 'include' });
        const vlansData = await vlansResp.json();
        const vlansDiv = document.getElementById('dep-vlans');
        if (vlansData.status === 1) {
            vlansDiv.innerHTML = '‚úÖ VLANs: Activo';
            vlansDiv.style.color = '#155724';
            // Habilitar bot√≥n START
            btnStart.disabled = false;
            btnStart.title = '';
        } else {
            vlansDiv.innerHTML = '‚ùå VLANs: Inactivo (Requerido)';
            vlansDiv.style.color = '#721c24';
            // Deshabilitar bot√≥n START
            btnStart.disabled = true;
            btnStart.title = 'VLANs debe estar activo primero';
        }
    } catch {
        document.getElementById('dep-vlans').innerHTML = '‚ö†Ô∏è VLANs: Error al verificar';
        // Deshabilitar bot√≥n START por error
        btnStart.disabled = true;
        btnStart.title = 'Error al verificar dependencias';
    }
}

// Verificar dependencias al cargar
window.addEventListener("DOMContentLoaded", () => {
    checkDependencies();
    // Actualizar dependencias cada 5 segundos
    setInterval(checkDependencies, 5000);
});
</script>

</body>
</html>