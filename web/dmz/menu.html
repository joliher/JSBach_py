<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>DMZ - Men煤</title>
    <style>
        html, body {
            margin: 0;
            font-family: Arial, sans-serif;
            padding: 10px;
            background-color: #f5f5f5;
        }
        h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            display: block;
            width: 100%;
            margin: 5px 0;
            padding: 10px 12px;
            cursor: pointer;
            border: 1px solid #ccc;
            background-color: #fff;
            font-size: 14px;
            transition: all 0.2s;
        }
        button:hover {
            background-color: #e8f4ff;
        }
        button.selected {
            background-color: #3399ff;
            color: white;
            border-color: #007acc;
            font-weight: bold;
        }
        hr {
            border: none;
            border-top: 1px solid #ddd;
            margin: 15px 0;
        }
        .status-box {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            padding: 8px 12px;
            margin: 10px 0;
            text-align: center;
            font-size: 13px;
            transition: all 0.3s;
        }
        .status-box.activo {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        .status-box.inactivo {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        .status-box.desconocido {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }
    </style>
</head>
<body>

<h3> DMZ</h3>

<div class="status-box" id="module-status">Estado: Cargando...</div>

<!-- Acciones principales -->
<button id="btnStart" onclick="executeAction('start', this)"> DMZ START</button>
<button id="btnStop" onclick="executeAction('stop', this)"> DMZ STOP</button>
<button id="btnRestart" onclick="executeAction('restart', this)"> DMZ RESTART</button>
<button id="btnStatus" onclick="openPage('status', this)"> DMZ STATUS</button>

<hr>

<h4 style="margin: 10px 0; color: #555;">Configuraci贸n</h4>

<button id="btnConfig" onclick="openPage('config', this)">锔 DMZ CONFIG</button>

<hr>

<button id="btnInfo" onclick="openPage('info', this)">癸 VER INFO</button>

<script>
function openPage(page, btn) {
    const iframe = parent.frames['body'];
    
    // Resaltar bot贸n seleccionado
    document.querySelectorAll("button").forEach(b => b.classList.remove("selected"));
    btn.classList.add("selected");
    sessionStorage.setItem("dmzSelected", btn.id);
    
    iframe.location.href = `/web/dmz/${page}.html`;
}

function executeAction(action, btn) {
    const iframe = parent.frames['body'];
    
    // Resaltar bot贸n seleccionado
    document.querySelectorAll("button").forEach(b => b.classList.remove("selected"));
    btn.classList.add("selected");
    sessionStorage.setItem("dmzSelected", btn.id);
    
    // Cargar logs.html para todas las acciones
    iframe.location.href = "/web/dmz/logs.html";
    
    // Ejecutar acci贸n en segundo plano
    console.log('DMZ: Iniciando fetch a /admin/dmz con action:', action);
    
    fetch('/admin/dmz', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ action: action })
    })
    .then(response => {
        console.log('DMZ: Respuesta recibida:', response.status, response.statusText);
        return response.json();
    })
    .then(data => {
        console.log('DMZ: Datos recibidos:', data);
    })
    .catch(error => {
        console.error('DMZ: Error ejecutando acci贸n:', error);
    });
}

// Restaurar el bot贸n seleccionado al cargar la p谩gina
window.onload = function() {
    const selected = sessionStorage.getItem("dmzSelected");
    if (selected) {
        const btn = document.getElementById(selected);
        if (btn) btn.classList.add("selected");
    }
    fetchModuleStatus();
};

// Funci贸n para obtener el estado del m贸dulo con polling adaptativo
let lastStatus = '';
let pollInterval = 2000;
let unchangedCount = 0;
let statusTimerId = null;

function fetchModuleStatus() {
    fetch('/admin/status', { credentials: 'include' })
        .then(response => response.json())
        .then(data => {
            const status = data['dmz'] || 'DESCONOCIDO';
            
            if (status === lastStatus) {
                // Si no cambi贸, ralentizar gradualmente
                unchangedCount++;
                if (unchangedCount > 3) pollInterval = 5000;   // Despu茅s de 3 = 5s
                if (unchangedCount > 10) pollInterval = 10000; // Despu茅s de 10 = 10s
                if (unchangedCount > 20) pollInterval = 30000; // Despu茅s de 20 = 30s
            } else {
                // Si cambi贸, volver a polling r谩pido y actualizar UI
                lastStatus = status;
                unchangedCount = 0;
                pollInterval = 2000;
                
                const statusBox = document.getElementById('module-status');
                statusBox.textContent = `Estado: ${status}`;
                statusBox.classList.remove('activo', 'inactivo', 'desconocido');
                
                if (status === 'ACTIVO') {
                    statusBox.classList.add('activo');
                } else if (status === 'INACTIVO') {
                    statusBox.classList.add('inactivo');
                } else {
                    statusBox.classList.add('desconocido');
                }
            }
            
            // Re-programar con el nuevo intervalo
            clearTimeout(statusTimerId);
            statusTimerId = setTimeout(fetchModuleStatus, pollInterval);
        })
        .catch(error => {
            console.error('Error al obtener estado:', error);
            clearTimeout(statusTimerId);
            statusTimerId = setTimeout(fetchModuleStatus, 5000); // Retry en 5s
        });
}
</script>

</body>
</html>
