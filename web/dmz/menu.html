<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>DMZ - Men√∫</title>
    <style>
        html, body {
            margin: 0;
            font-family: Arial, sans-serif;
            padding: 10px;
            background-color: #f5f5f5;
        }
        h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            display: block;
            width: 100%;
            margin: 5px 0;
            padding: 10px 12px;
            cursor: pointer;
            border: 1px solid #ccc;
            background-color: #fff;
            font-size: 14px;
            transition: all 0.2s;
        }
        button:hover {
            background-color: #e8f4ff;
        }
        button.selected {
            background-color: #3399ff;
            color: white;
            border-color: #007acc;
            font-weight: bold;
        }
        hr {
            border: none;
            border-top: 1px solid #ddd;
            margin: 15px 0;
        }
        .status-box {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            padding: 8px 12px;
            margin: 10px 0;
            text-align: center;
            font-size: 13px;
            transition: all 0.3s;
        }
        .status-box.activo {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        .status-box.inactivo {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        .status-box.desconocido {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #e9ecef;
        }
        button:disabled:hover {
            background-color: #e9ecef;
        }
        .dependency-warning {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 6px;
            padding: 8px 10px;
            margin: 10px 0;
            font-size: 12px;
            color: #856404;
            display: none;
        }
    </style>
</head>
<body>

<h3>üì° DMZ</h3>

<div class="status-box" id="module-status">Estado: Cargando...</div>

<div class="dependency-warning" id="wan-warning">
    ‚ö†Ô∏è La WAN debe estar configurada antes de iniciar la DMZ
</div>

<!-- Acciones principales -->
<button id="btnStart" onclick="executeAction('start', this)">üöÄ DMZ START</button>
<button id="btnStop" onclick="executeAction('stop', this)">üõë DMZ STOP</button>
<button id="btnRestart" onclick="executeAction('restart', this)">üîÑ DMZ RESTART</button>
<button id="btnStatus" onclick="executeAction('status', this)">üìä DMZ STATUS</button>

<hr>

<h4 style="margin: 10px 0; color: #555;">Configuraci√≥n y Vista</h4>

<button id="btnConfig" onclick="openPage('config', this)">‚öôÔ∏è DMZ CONFIG</button>
<button id="btnDestinations" onclick="openPage('destinations', this)">üìã VER DESTINOS</button>

<hr>

<button id="btnInfo" onclick="openPage('info', this)">‚ÑπÔ∏è VER INFO</button>

<script>
function openPage(page, btn) {
    const iframe = parent.frames['body'];
    
    // Resaltar bot√≥n seleccionado
    document.querySelectorAll("button").forEach(b => b.classList.remove("selected"));
    btn.classList.add("selected");
    sessionStorage.setItem("dmzSelected", btn.id);
    
    iframe.location.href = `/web/dmz/${page}.html`;
}

function executeAction(action, btn) {
    const iframe = parent.frames['body'];
    
    // Resaltar bot√≥n seleccionado
    document.querySelectorAll("button").forEach(b => b.classList.remove("selected"));
    btn.classList.add("selected");
    sessionStorage.setItem("dmzSelected", btn.id);
    
    // START/STOP/RESTART/STATUS ‚Üí cargar status.html para feedback
    if (action === 'start' || action === 'stop' || action === 'restart' || action === 'status') {
        iframe.location.href = "/web/dmz/status.html";
    } else {
        // Otras acciones ‚Üí mostrar info.html
        iframe.location.href = "/web/dmz/info.html";
    }
    
    // Ejecutar acci√≥n en segundo plano
    console.log('DMZ: Iniciando fetch a /admin/dmz con action:', action);
    
    fetch('/admin/dmz', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ action: action })
    })
    .then(response => {
        console.log('DMZ: Respuesta recibida:', response.status, response.statusText);
        return response.json();
    })
    .then(data => {
        console.log('DMZ: Datos recibidos:', data);
    })
    .catch(error => {
        console.error('DMZ: Error ejecutando acci√≥n:', error);
    });
}

// Restaurar el bot√≥n seleccionado al cargar la p√°gina
window.onload = function() {
    const selected = sessionStorage.getItem("dmzSelected");
    if (selected) {
        const btn = document.getElementById(selected);
        if (btn) btn.classList.add("selected");
    }
    fetchModuleStatus();
};

// Variables para polling adaptativo
let wanConfigured = false;
let lastStatus = null;
let unchangedCount = 0;
let pollInterval = 2000;
let statusTimerId = null;

function fetchModuleStatus() {
    fetch('/admin/status', { credentials: 'include' })
        .then(response => response.json())
        .then(data => {
            const status = data['dmz'] || 'DESCONOCIDO';
            const wanStatus = data['wan'] || 'DESCONOCIDO';
            
            // Verificar si WAN est√° configurada
            wanConfigured = (wanStatus !== 'DESCONOCIDO' && wanStatus !== 'ERROR');
            
            // Deshabilitar bot√≥n START si WAN no est√° configurada
            const btnStart = document.getElementById('btnStart');
            const wanWarning = document.getElementById('wan-warning');
            
            if (!wanConfigured) {
                btnStart.disabled = true;
                btnStart.title = 'La WAN debe estar configurada primero';
                wanWarning.style.display = 'block';
            } else {
                btnStart.disabled = false;
                btnStart.title = '';
                wanWarning.style.display = 'none';
            }
            
            // Actualizar UI de estado con polling adaptativo
            if (status === lastStatus) {
                // Si no cambi√≥, ralentizar gradualmente
                unchangedCount++;
                if (unchangedCount > 3) pollInterval = 5000;   // Despu√©s de 3 = 5s
                if (unchangedCount > 10) pollInterval = 10000; // Despu√©s de 10 = 10s
                if (unchangedCount > 20) pollInterval = 30000; // Despu√©s de 20 = 30s
            } else {
                // Si cambi√≥, volver a polling r√°pido y actualizar UI
                lastStatus = status;
                unchangedCount = 0;
                pollInterval = 2000;
                
                const statusBox = document.getElementById('module-status');
                statusBox.textContent = `Estado: ${status}`;
                statusBox.classList.remove('activo', 'inactivo', 'desconocido');
                
                if (status === 'ACTIVO') {
                    statusBox.classList.add('activo');
                } else if (status === 'INACTIVO') {
                    statusBox.classList.add('inactivo');
                } else {
                    statusBox.classList.add('desconocido');
                }
            }
            
            // Re-programar con el nuevo intervalo
            clearTimeout(statusTimerId);
            statusTimerId = setTimeout(fetchModuleStatus, pollInterval);
        })
        .catch(error => {
            console.error('Error al obtener estado:', error);
            clearTimeout(statusTimerId);
            statusTimerId = setTimeout(fetchModuleStatus, 5000); // Retry en 5s
        });
}
</script>

</body>
</html>
