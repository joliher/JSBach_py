<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>DMZ - Manual de Uso</title>
    
    <link rel="stylesheet" href="/web/00-css/dmz/info.css">
</head>
<body>
    <div class="info-container">
        <h2>üì° DMZ - Manual de Uso</h2>
        
        <div class="section">
            <h3>üìã Descripci√≥n General</h3>
            <p>El m√≥dulo DMZ (DeMilitarized Zone) permite exponer servicios internos de la red hacia Internet de forma controlada. Utiliza <strong>arquitectura jer√°rquica con cadenas por VLAN</strong> para aplicar reglas DNAT organizadas y compatibles con el firewall.</p>
            <p><strong>Arquitectura V2.0:</strong> PREROUTING_VLAN_X (reglas DNAT) + FORWARD_VLAN_X (reglas ACCEPT con prioridad)</p>
        </div>

        <div class="section">
            <h3>‚öôÔ∏è Requisitos Previos</h3>
            <ul>
                <li><strong>‚ö†Ô∏è WAN debe estar configurada</strong> - La DMZ requiere que la interfaz WAN est√© configurada antes de iniciarse</li>
                <li><strong>‚ö†Ô∏è FIREWALL debe estar activo</strong> - Las cadenas FORWARD_VLAN_X son necesarias para las reglas ACCEPT</li>
                <li><strong>‚ö†Ô∏è VLANs deben estar activas</strong> - Para vincular cadenas PREROUTING_VLAN_X</li>
                <li>Los destinos pueden estar en cualquier VLAN v√°lida (no solo VLAN 2)</li>
                <li>Verificar con: <code>iptables -t nat -L -n</code></li>
            </ul>
        </div>

        <div class="section">
            <h3>üéØ Funciones Principales</h3>
            
            <p><strong>ADD_DESTINATION:</strong> A√±adir nuevo destino DMZ</p>
            <ul>
                <li>Valida IP (debe ser privada y pertenecer a una VLAN configurada)</li>
                <li>Valida puerto (1-65535) y protocolo (tcp/udp)</li>
                <li>Verifica duplicados</li>
                <li>Guarda configuraci√≥n en <code>config/dmz/dmz.json</code></li>
                <li><strong>Si DMZ est√° activo, aplica regla inmediatamente (restart autom√°tico)</strong></li>
            </ul>

            <p><strong>START:</strong> Activar todas las reglas DMZ</p>
            <ul>
                <li>Verifica dependencias (WAN, FIREWALL, VLANs)</li>
                <li>Crea cadenas PREROUTING_VLAN_X y las vincula a PREROUTING (nat table)</li>
                <li>Aplica reglas DNAT: <code>-i &lt;wan&gt; -p &lt;proto&gt; --dport &lt;port&gt; -j DNAT --to-destination &lt;ip&gt;</code></li>
                <li><strong>Inserta regla ACCEPT en FORWARD_VLAN_X en posici√≥n 1</strong> (antes de whitelist/DROP)</li>
                <li>‚ö†Ô∏è <strong>Advertencia si IP no est√° en whitelist</strong> (DMZ tiene prioridad por dise√±o)</li>
                <li>Actualiza estado a activo</li>
            </ul>

            <p><strong>STOP:</strong> Desactivar todas las reglas DMZ</p>
            <ul>
                <li>Elimina reglas ACCEPT de cada FORWARD_VLAN_X</li>
                <li>Desvincular y eliminar cadenas PREROUTING_VLAN_X</li>
                <li>Actualiza estado a inactivo</li>
            </ul>

            <p><strong>REMOVE_DESTINATION:</strong> Eliminar destino DMZ espec√≠fico</p>
            <ul>
                <li>Busca y elimina destino de configuraci√≥n</li>
                <li><strong>Si DMZ est√° activo, reaplicar reglas (restart autom√°tico)</strong></li>
            </ul>

            <p><strong>ISOLATE_DMZ_HOST:</strong> Aislar host DMZ individual (NUEVO)</p>
            <ul>
                <li>Bloquea COMPLETAMENTE el tr√°fico del host DMZ</li>
                <li><strong>PREROUTING (NAT):</strong> Inserta RETURN en posici√≥n 1 de PREROUTING_PROTECTION (impide DNAT, bloquea port forwarding)</li>
                <li><strong>INPUT (FILTER):</strong> Inserta DROP en posici√≥n 1 de INPUT (bloquea tr√°fico desde el host hacia el router)</li>
                <li>Prevalece sobre whitelist, DMZ, y cualquier otra regla (ocurre ANTES de DNAT)</li>
                <li>Marca el host como <code>isolated: true</code> en dmz.json</li>
                <li>√ötil para respuesta r√°pida ante incidentes de seguridad</li>
            </ul>

            <p><strong>UNISOLATE_DMZ_HOST:</strong> Desaislar host DMZ individual (NUEVO)</p>
            <ul>
                <li>Elimina la regla RETURN de PREROUTING_PROTECTION (NAT)</li>
                <li>Elimina la regla DROP de INPUT (FILTER)</li>
                <li>Restaura el tr√°fico seg√∫n las reglas configuradas (DNAT, DMZ, whitelist, etc.)</li>
                <li>Marca el host como <code>isolated: false</code> en dmz.json</li>
            </ul>
        </div>

        <div class="section">
            <h3>üìä STATUS - Vista de Destinos</h3>
            <p>La p√°gina de STATUS muestra una tabla con todos los destinos configurados:</p>
            <ul>
                <li><strong>IP:</strong> Direcci√≥n de destino interna</li>
                <li><strong>Puerto:</strong> Puerto redirigido</li>
                <li><strong>Protocolo:</strong> TCP o UDP</li>
                <li><strong>Estado:</strong> 
                    <ul>
                        <li>üîí <strong>AISLADO:</strong> Host bloqueado (RETURN en PREROUTING_PROTECTION, NAT pos. 1 - impide DNAT)</li>
                        <li>‚úÖ <strong>ACTIVO:</strong> DMZ funcionando normalmente</li>
                        <li>‚è∏Ô∏è <strong>CONFIGURADO:</strong> Destino guardado pero DMZ inactivo</li>
                    </ul>
                </li>
                <li><strong>Acciones:</strong> 
                    <ul>
                        <li>üîí <strong>AISLAR:</strong> Bloquear host inmediatamente (m√°xima prioridad)</li>
                        <li>üîì <strong>DESAISLAR:</strong> Restaurar acceso del host</li>
                        <li>üóëÔ∏è <strong>ELIMINAR:</strong> Remover destino de la configuraci√≥n</li>
                    </ul>
                </li>
            </ul>
        </div>

        <div class="section">
            <h3>üéØ Orden de Prioridad de Reglas</h3>
            <p>El sistema eval√∫a las reglas en el siguiente orden (mayor a menor prioridad):</p>
            <ol>
                <li><strong>1Ô∏è‚É£ PREROUTING_PROTECTION pos. 1 (NAT):</strong> RETURN host DMZ aislado (ISOLATE_DMZ_HOST)</li>
                <li><strong>2Ô∏è‚É£ PREROUTING_VLAN_X (NAT):</strong> DNAT (port forwarding) para destinos DMZ activos</li>
                <li><strong>3Ô∏è‚É£ FORWARD_PROTECTION (FILTER):</strong> DROP VLAN aislada (firewall aislar)</li>
                <li><strong>4Ô∏è‚É£ FORWARD_VLAN_X pos. 1 (FILTER):</strong> ACCEPT destinos DMZ activos</li>
                <li><strong>5Ô∏è‚É£ FORWARD_VLAN_X (FILTER):</strong> ACCEPT whitelist (si est√° activa)</li>
                <li><strong>6Ô∏è‚É£ FORWARD_VLAN_X final (FILTER):</strong> DROP por defecto (si whitelist activa)</li>
            </ol>
            <p><strong>Ejemplo pr√°ctico:</strong> Si un host DMZ est√° aislado, el DNAT no se aplica (RETURN en PREROUTING_PROTECTION), por lo que el puerto forwarding se bloquea ANTES del routing. El tr√°fico nunca llega al host, incluso si est√° en la whitelist o tiene reglas DMZ configuradas.</p>
            <p><strong>Tabla NAT vs Tabla FILTER:</strong> El aislamiento DMZ ocurre en PREROUTING (NAT) antes que el forwarding (FILTER), garantizando bloqueo total.</p>
        </div>

        <div class="warning">
            <h3>‚ö†Ô∏è Consideraciones de Seguridad</h3>
            <ul>
                <li>Exponer servicios a Internet conlleva riesgos de seguridad</li>
                <li><strong>DMZ funciona con cualquier VLAN</strong>, pero se recomienda VLAN dedicada para servicios p√∫blicos</li>
                <li><strong>DMZ tiene prioridad sobre whitelist:</strong> las reglas ACCEPT se insertan en posici√≥n 1 de FORWARD_VLAN_X</li>
                <li><strong>Aislamiento DMZ tiene M√ÅXIMA prioridad:</strong> prevalece sobre todo usando PREROUTING_PROTECTION (NAT, pos. 1) que bloquea ANTES de DNAT</li>
                <li>Si la VLAN tiene whitelist activa y la IP DMZ no est√° en ella, se mostrar√° advertencia pero funcionar√°</li>
                <li><strong>Usa AISLAR para respuesta r√°pida:</strong> bloquea DNAT de un host comprometido inmediatamente (impide port forwarding)</li>
                <li>Mant√©n los servicios actualizados y parcheados</li>
                <li>Implementa firewall en los propios servidores DMZ</li>
                <li>Monitoriza logs regularmente en <code>logs/dmz/actions.log</code></li>
            </ul>
        </div>

        <div class="success">
            <h3>‚úÖ Ejemplo Pr√°ctico</h3>
            <p><strong>Escenario:</strong> Exponer servidor web en 10.0.5.100</p>
            <ol>
                <li>Asegurarse de que FIREWALL est√© activo (START firewall)</li>
                <li>Ir a CONFIG y a√±adir: IP=<code>10.0.5.100</code>, Puerto=<code>80</code>, Protocolo=<code>TCP</code></li>
                <li>Ir a STATUS y hacer clic en START DMZ</li>
                <li>El sistema crear√°:
                    <ul>
                        <li>Cadena PREROUTING_VLAN_5 con regla DNAT</li>
                        <li>Regla ACCEPT en FORWARD_VLAN_5 (posici√≥n 1)</li>
                    </ul>
                </li>
                <li>El tr√°fico HTTP entrante ser√° redirigido autom√°ticamente</li>
                <li>A√±adir m√°s destinos con ADD_DESTINATION (restart autom√°tico)</li>
            </ol>
        </div>

        <div class="section">
            <h3>üîß Resoluci√≥n de Problemas</h3>
            <ul>
                <li><strong>START no funciona:</strong> Verificar que FIREWALL est√© activo primero</li>
                <li><strong>Error "FIREWALL debe estar activo":</strong> Ejecutar START en el m√≥dulo firewall</li>
                <li><strong>No llega tr√°fico:</strong> Comprobar que WAN est√© configurada correctamente</li>
                <li><strong>Puerto no responde:</strong> Verificar que el servicio interno est√© escuchando</li>
                <li><strong>Conflictos con whitelist:</strong> La advertencia es informativa, DMZ funciona correctamente</li>
                <li><strong>Verificar reglas:</strong> <code>sudo iptables -t nat -L PREROUTING_VLAN_X -n -v</code></li>
                <li><strong>Verificar ACCEPT:</strong> <code>sudo iptables -L FORWARD_VLAN_X -n --line-numbers</code></li>
            </ul>
        </div>

        <div class="section">
            <h3>üîÑ Versi√≥n</h3>
            <p>DMZ Module v2.0 - Arquitectura Jer√°rquica Compatible con Firewall</p>
            <p><strong>Nuevo en v2.0 (Refactorizaci√≥n Completa):</strong></p>
            <ul>
                <li>üèóÔ∏è <strong>Arquitectura jer√°rquica:</strong> PREROUTING_VLAN_X + integraci√≥n con FORWARD_VLAN_X</li>
                <li>üéØ <strong>Reglas ACCEPT en posici√≥n 1:</strong> DMZ tiene prioridad sobre whitelist</li>
                <li>ÔøΩ <strong>Aislamiento individual:</strong> ISOLATE_DMZ_HOST/UNISOLATE_DMZ_HOST (m√°xima prioridad)</li>
                <li>üîß <strong>Validaci√≥n estricta:</strong> IP privada, puerto v√°lido, VLAN existente, range checking</li>
                <li>üîÑ <strong>Restart autom√°tico:</strong> Al a√±adir/eliminar destinos con DMZ activo</li>
                <li>‚ö†Ô∏è <strong>Advertencias informativas:</strong> Si IP DMZ no est√° en whitelist de su VLAN</li>
                <li>üìù <strong>Logs detallados:</strong> Todas las operaciones registradas en logs/dmz/actions.log</li>
                <li>‚úÖ <strong>Preservaci√≥n de reglas:</strong> DMZ ACCEPT se preserva al modificar whitelist (Bug #9/#10 corregido)</li>
                <li>üõ°Ô∏è <strong>Sin duplicaci√≥n:</strong> Verificaci√≥n con -C antes de insertar reglas</li>
            </ul>
            <p><strong>Versiones anteriores:</strong></p>
            <ul>
                <li>v1.x: Arquitectura legacy con cadena SECURITY_DROPS_DMZ y aislamiento manual</li>
            </ul>
            <p>√öltima actualizaci√≥n: Enero 2026</p>
        </div>
    </div>
</body>
</html>